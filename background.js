async function handleProcessQuestion(e,t,a){try{const t=await chrome.tabs.query({url:"https://www.perplexity.ai/*"});let r;t.length>0?r=t[0]:(r=await chrome.tabs.create({url:"https://www.perplexity.ai/",active:!0}),await waitForTabLoad(r.id)),await chrome.tabs.update(r.id,{url:"https://www.perplexity.ai/",active:!0}),await sleep(2e3),await waitForTabLoad(r.id);let i=await waitForContentScript(r.id);if(!i&&(await chrome.tabs.reload(r.id),await sleep(3e3),await waitForTabLoad(r.id),i=await waitForContentScript(r.id),!i))throw new Error("Content script not ready even after page refresh. Please try manually refreshing the Perplexity page (F5).");a(await chrome.tabs.sendMessage(r.id,{type:"ASK_QUESTION",question:e.question,questionId:e.questionId}))}catch(e){a({success:!1,error:e.message})}}async function waitForContentScript(e,t=25){for(let a=0;a<t;a++)try{const t=await chrome.tabs.sendMessage(e,{type:"PING"});if(t&&t.ready)return!0}catch(e){await sleep(1200)}return!1}function sleep(e){return new Promise(t=>setTimeout(t,e))}async function handleOpenPerplexity(e,t){try{const e="https://www.perplexity.ai/",a=await chrome.tabs.query({url:"https://www.perplexity.ai/*"});if(a.length>0)await chrome.tabs.update(a[0].id,{url:e,active:!0}),t({success:!0,tabId:a[0].id});else{t({success:!0,tabId:(await chrome.tabs.create({url:e,active:!0})).id})}}catch(e){t({success:!1,error:e.message})}}async function waitForTabLoad(e){if("complete"!==(await chrome.tabs.get(e)).status)return new Promise(t=>{chrome.tabs.onUpdated.addListener(function a(r,i){r===e&&"complete"===i.status&&(chrome.tabs.onUpdated.removeListener(a),setTimeout(t,5e3))})});await sleep(5e3)}async function forwardToSidePanel(e){try{await chrome.runtime.sendMessage(e)}catch(e){}try{await chrome.storage.local.set({pendingMessage:{...e,timestamp:Date.now()}})}catch(e){}}chrome.action.onClicked.addListener(e=>{chrome.sidePanel.open({windowId:e.windowId})}),chrome.runtime.onMessage.addListener((e,t,a)=>{switch(e.type){case"PROCESS_QUESTION":return handleProcessQuestion(e,t,a),!0;case"UPDATE_PROGRESS":case"LOG_MESSAGE":forwardToSidePanel(e);break;case"QUESTION_COMPLETE":return forwardToSidePanel(e),a({received:!0}),!0;case"OPEN_CHATGPT":return handleOpenPerplexity(e,a),!0}}),chrome.tabs.onUpdated.addListener((e,t,a)=>{"complete"===t.status&&a.url&&a.url.includes("perplexity.ai")});