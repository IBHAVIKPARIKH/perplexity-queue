let currentQuestion=null,currentAnswer="",currentSources=[],currentReferences=[],isProcessing=!1,isParsing=!1,sseChunks=[];function injectSSEInterceptor(){try{const e=document.createElement("script");e.src=chrome.runtime.getURL("injected.js"),e.onload=function(){this.remove()},e.onerror=function(){this.remove()},(document.head||document.documentElement).appendChild(e)}catch(e){}}function handleSSEData(e){isProcessing&&currentQuestion&&sseChunks.push(e)}async function handleSSEDone(){isParsing||isProcessing&&currentQuestion&&sseChunks.length>0&&(isParsing=!0,await parseSSEWithBackend())}async function handleStreamEnd(){}async function parseSSEWithBackend(){if(currentQuestion)try{const e=await chrome.storage.local.get(["authToken"]);if(!e.authToken)throw new Error("Not authenticated. Please login first.");const t=CONFIG.DEFAULT_SERVER_URL,n=await fetch(`${t}/api/pplx-sse/parse`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.authToken}`},body:JSON.stringify({question:currentQuestion.question,sse_chunks:sseChunks})});if(!n.ok){if(401===n.status)throw new Error("Authentication expired. Please login again.");const e=await n.json();throw new Error(e.detail||"Backend API error")}const r=await n.json();currentAnswer=r.answer.answer||"",currentSources=r.answer.sources||[],currentReferences=r.answer.references||[],handleAnswerComplete()}catch(e){sendQuestionResult(!1,`Backend parsing error: ${e.message}`)}finally{isParsing=!1}}function handleSSEError(e){isProcessing&&currentQuestion&&sendQuestionResult(!1,e)}function handleAnswerComplete(){isProcessing&&currentQuestion&&(currentAnswer.length,sendQuestionResult(!0))}function sendQuestionResult(e,t=null){const n={success:e,questionId:currentQuestion.questionId,question:currentQuestion.question,answer:currentAnswer,sources:currentSources,error:t};chrome.runtime.sendMessage({type:"QUESTION_COMPLETE",result:n},e=>{chrome.runtime.lastError}),isProcessing=!1,currentQuestion=null,currentAnswer="",currentSources=[],currentReferences=[],sseChunks=[]}function waitForElement(e,t=1e4){return new Promise((n,r)=>{const s=document.querySelector(e);if(s)return void n(s);const i=new MutationObserver(()=>{const t=document.querySelector(e);t&&(i.disconnect(),n(t))});i.observe(document.body,{childList:!0,subtree:!0}),setTimeout(()=>{i.disconnect(),r(new Error(`Timeout waiting for element: ${e}`))},t)})}function clickElement(e){if(!e)return!1;try{e.scrollIntoView({behavior:"instant",block:"center"})}catch(e){}try{return e.click(),!0}catch(e){}try{return e.dispatchEvent(new MouseEvent("mousedown",{bubbles:!0,cancelable:!0,view:window})),e.dispatchEvent(new MouseEvent("mouseup",{bubbles:!0,cancelable:!0,view:window})),e.dispatchEvent(new MouseEvent("click",{bubbles:!0,cancelable:!0,view:window})),!0}catch(e){}try{return e.dispatchEvent(new PointerEvent("pointerdown",{bubbles:!0,cancelable:!0})),e.dispatchEvent(new PointerEvent("pointerup",{bubbles:!0,cancelable:!0})),e.click(),!0}catch(e){}return!1}async function clickWithEvents(e){const t=e.getBoundingClientRect(),n=t.left+t.width/2,r=t.top+t.height/2,s=new MouseEvent("mouseover",{bubbles:!0,cancelable:!0,view:window,clientX:n,clientY:r}),i=new MouseEvent("mousedown",{bubbles:!0,cancelable:!0,view:window,clientX:n,clientY:r,button:0}),o=new MouseEvent("mouseup",{bubbles:!0,cancelable:!0,view:window,clientX:n,clientY:r,button:0}),c=new MouseEvent("click",{bubbles:!0,cancelable:!0,view:window,clientX:n,clientY:r,button:0});e.dispatchEvent(s),await sleep(50),e.dispatchEvent(i),await sleep(50),e.dispatchEvent(o),await sleep(50),e.dispatchEvent(c),e.click()}async function inputQuestion(e){try{let t=document.querySelector('#ask-input[contenteditable="true"]');if(t||(t=document.querySelector('div[contenteditable="true"][role="textbox"]')),t||(t=document.querySelector('div[contenteditable="true"][data-lexical-editor="true"]')),t||(t=document.querySelector('div[contenteditable="true"]')),!t)throw new Error("Perplexity input element not found");t.focus(),await sleep(300),t.textContent="",t.textContent=e,t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0}));const n=new InputEvent("input",{bubbles:!0,cancelable:!0,composed:!0,data:e,inputType:"insertText"});t.dispatchEvent(n);const r=new KeyboardEvent("keydown",{bubbles:!0,cancelable:!0,composed:!0});return t.dispatchEvent(r),await sleep(500),!0}catch(e){return!1}}async function submitQuestion(){try{await sleep(500);let e=document.querySelector('button[data-testid="submit-button"]');if(e||(e=document.querySelector('button[aria-label="Submit"]')),!e){e=Array.from(document.querySelectorAll("button")).find(e=>null!==e.querySelector('use[xlink\\:href*="arrow-right"]'))}if(!e)throw new Error("Could not find Perplexity submit button");if(e.disabled){let t=0;for(;e.disabled&&t<30;)await sleep(100),t++;if(e.disabled)throw new Error("Submit button remained disabled")}return await clickElement(e),await sleep(1e3),!0}catch(e){return!1}}function sleep(e){return new Promise(t=>setTimeout(t,e))}async function askQuestion(e,t){currentQuestion={question:e,questionId:t},currentAnswer="",currentSources=[],currentReferences=[],sseChunks=[],isProcessing=!0,isParsing=!1;try{if(!await inputQuestion(e))throw new Error("Failed to input question");if(!await submitQuestion())throw new Error("Failed to submit question");return setTimeout(()=>{isProcessing&&currentQuestion&&currentQuestion.questionId===t&&(currentAnswer?handleAnswerComplete():sendQuestionResult(!1,"Timeout waiting for answer"))},12e4),{success:!0,message:"Question submitted, waiting for answer"}}catch(e){return sendQuestionResult(!1,e.message),{success:!1,error:e.message}}}function initializeContentScript(){"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{injectSSEInterceptor()}):injectSSEInterceptor()}window.addEventListener("message",e=>{if(e.source!==window)return;const{type:t,data:n}=e.data;switch(t){case"SSE_DATA":handleSSEData(n);break;case"SSE_DONE":handleSSEDone();break;case"SSE_STREAM_END":handleStreamEnd();break;case"SSE_ERROR":handleSSEError(e.data.error)}}),chrome.runtime.onMessage.addListener((e,t,n)=>"PING"===e.type?(n({ready:!0}),!0):"ASK_QUESTION"===e.type?(askQuestion(e.question,e.questionId).then(e=>n(e)).catch(e=>n({success:!1,error:e.message})),!0):void 0),initializeContentScript();