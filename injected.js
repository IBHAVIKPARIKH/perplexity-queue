!function(){const t=window.fetch;window.fetch=async function(...e){const[s,o]=e;let n="";"string"==typeof s?n=s:s instanceof Request?n=s.url:s instanceof URL?n=s.href:s&&"object"==typeof s&&s.url&&(n=s.url);if(n&&n.includes("/rest/sse/perplexity_ask"))try{const s=await t.apply(this,e);if(!s.ok)return s;const o=s.clone();if(!o.body)return s;const n=o.body.getReader(),a=new TextDecoder;return(async()=>{let t="",e=!1;try{for(;;){const{done:o,value:r}=await n.read();if(o){t.trim()&&s(t.trim()),window.postMessage({type:"SSE_STREAM_END"},"*");break}t+=a.decode(r,{stream:!0});const i=t.split("\n");t=i.pop()||"";for(const t of i)s(t.trim());if(e){window.postMessage({type:"SSE_STREAM_END"},"*");break}}}catch(t){window.postMessage({type:"SSE_ERROR",error:t.message},"*")}function s(t){if(t&&t.startsWith("data: ")){const s=t.substring(6);try{const t=JSON.parse(s);window.postMessage({type:"SSE_DATA",data:t},"*"),!0!==t.text_completed&&!0!==t.final||(e=!0,window.postMessage({type:"SSE_DONE"},"*")),!0===t.final_sse_message&&(e=!0,window.postMessage({type:"SSE_DONE"},"*"))}catch(t){}}}})(),s}catch(t){throw t}return t.apply(this,e)}}();